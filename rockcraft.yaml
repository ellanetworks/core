name: ella-core
base: bare
build-base: ubuntu@24.04
adopt-info: core-release-data
summary: Ella Core is a secure, reliable, and easy to operate mobile network.
description: Ella Core is a secure, reliable, and easy to operate mobile network.
platforms:
  amd64:
  arm64:

services:
  ella-core:
    override: replace
    summary: Ella Core is a private mobile network.
    command: core --config /core.yaml
    startup: enabled
    on-failure: restart

parts:
  core:
    plugin: go
    source: .
    source-type: local
    build-packages:
      - git
    build-snaps:
      - go/1.25/stable
      - node/22/stable
    stage-packages:
      - libc6_libs
    override-build: |
      npm install --prefix ui
      npm run build --prefix ui
      REVISION=`git rev-parse HEAD`
      go build -v -o ${CRAFT_PART_INSTALL}/bin/core -ldflags "-X github.com/ellanetworks/core/version.GitCommit=${REVISION}" ./cmd/core

  ip:
    plugin: nil
    stage-packages:
      - iproute2

  iptables:
    plugin: nil
    stage-packages:
      - iptables

  core-release-data:
    plugin: nil
    source: .
    override-build: |
      version="$(cat version/VERSION)"
      craftctl set version="$version"

  config:
    plugin: dump
    source: config/
    source-type: local

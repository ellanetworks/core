configs:
  ella_config:
    content: |
      logging:
        system:
          level: "debug"
          output: "stdout"
        audit:
          output: "stdout"
      db:
        path: "core.db"
      interfaces:
        n2:
          address: "10.3.0.2"
          port: 38412
        n3:
          name: "n3"
        n6:
          name: "n6"
        api:
          address: "0.0.0.0"
          port: 5002
      xdp:
        attach-mode: "generic"
  gnb_config:
    content: |
      mcc: '001'
      mnc: '01'

      nci: '0x000000010'
      idLength: 32
      tac: 1

      linkIp: 127.0.0.1
      ngapIp: 10.3.0.3
      gtpIp:  10.3.0.3

      amfConfigs:
        - address: 10.3.0.2
          port: 38412

      slices:
        - sst: 0x1
          sd: 0x102030

      ignoreStreamIds: false
  ue_config:
    content: |
      supi: 'imsi-001019756139935'
      mcc: '001'
      mnc: '01'
      protectionScheme: 0
      homeNetworkPublicKey: '75d1dde9519b390b172104ae3397557a114acbd39d3c39b2bcc3ce282abc4c3e'
      homeNetworkPublicKeyId: 1
      routingIndicator: '0000'

      key: '0eefb0893e6f1c2855a3a244c6db1277'
      op: '98da19bbc55e2a5b53857d10557b1d26'
      opType: 'OPC'
      amf: '8000'
      imei: '356938035643803'
      imeiSv: '4370816125816151'

      gnbSearchList:
        - 127.0.0.1

      uacAic:
        mps: false
        mcs: false

      uacAcc:
        normalClass: 0
        class11: false
        class12: false
        class13: false
        class14: false
        class15: false

      sessions:
        - type: 'IPv4'
          apn: 'internet'
          slice:
            sst: 0x01
            sd: 0x102030

      configured-nssai:
        - sst: 0x01
          sd: 0x102030

      default-nssai:
        - sst: 1
          sd: 1

      integrity:
        IA1: true
        IA2: true
        IA3: true

      ciphering:
        EA1: true
        EA2: true
        EA3: true

      integrityMaxRate:
        uplink: 'full'
        downlink: 'full'

services:
  ella-core:
    image: ella-core:latest
    configs:
      - source: ella_config
        target: /core.yaml
    restart: unless-stopped
    entrypoint: /bin/core --config /core.yaml
    volumes:
      - /sys/fs/bpf:/sys/fs/bpf:rw
    privileged: true
    ports:
      - "5002:5002"
    networks:
      default:
        driver_opts:
              com.docker.network.endpoint.ifname: eth0
      n3:
        driver_opts:
              com.docker.network.endpoint.ifname: n3
        ipv4_address: 10.3.0.2
      n6:
        driver_opts:
              com.docker.network.endpoint.ifname: n6
        ipv4_address: 10.6.0.2
  ueransim:
    image: ghcr.io/ellanetworks/ueransim:3.2.7
    configs:
      - source: gnb_config
        target: /gnb.yaml
      - source: ue_config
        target: /ue.yaml
    restart: unless-stopped
    privileged: true
    networks:
      default:
        driver_opts:
              com.docker.network.endpoint.ifname: eth0
      n3:
        driver_opts:
              com.docker.network.endpoint.ifname: n3
        ipv4_address: 10.3.0.3
  router:
    image: ghcr.io/ellanetworks/ubuntu-router:0.1
    command:
      - exec
      - /bin/bash
      - -lc
      - >
        ip route add 10.45.0.0/16 dev n6 via 10.6.0.2;
        trap : TERM INT;
        python3 /responder.py 34242 & wait
    restart: unless-stopped
    privileged: true
    networks:
      default: {}
      n6:
        driver_opts:
              com.docker.network.endpoint.ifname: n6
        ipv4_address: 10.6.0.3

networks:
  n3:
    internal: true
    ipam:
      config:
        - subnet: 10.3.0.0/24
  n6:  #  We can't use an internal network for n6 because Docker will drop our UE packets
    ipam:
      config:
        - subnet: 10.6.0.0/24

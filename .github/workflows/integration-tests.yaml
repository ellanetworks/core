name: Integration tests

on:
  workflow_call:

jobs:
  integration-test:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MicroK8s
        run: |
          echo "Installing snaps"
          sudo snap install microk8s --channel=1.31-strict/stable
          sudo snap install kubectl --classic
          sudo snap install docker
          
          echo "Adding user to microk8s group"
          sudo usermod -a -G snap_microk8s $USER

          echo "Starting MicroK8s"
          sudo -g snap_microk8s -E microk8s status --wait-ready --timeout=600 
          
          echo "Configuring kubectl"
          sudo mkdir -p /home/runner/.kube
          sudo -g snap_microk8s -E microk8s config | sudo tee /home/runner/.kube/config > /dev/null
          sudo chown -R $USER:$USER /home/runner/.kube
          export KUBECONFIG=/home/runner/.kube/config
          
          echo "Enabling MicroK8s addons"
          sudo -g snap_microk8s -E microk8s addons repo add community https://github.com/canonical/microk8s-community-addons --reference feat/strict-fix-multus
          sudo -g snap_microk8s -E sudo microk8s enable hostpath-storage
          sudo -g snap_microk8s -E sudo microk8s enable multus
          sudo -g snap_microk8s -E sudo microk8s enable metallb:10.0.0.2-10.0.0.4
          
          echo "Creating local registry"
          docker run -d -p 5000:5000 --name registry registry:2

      - name: Run integration tests
        run: |
          make oci-build
          make deploy
          make test

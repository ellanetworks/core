name: Integration tests

on:
  workflow_call:

jobs:
  integration-test:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MicroK8s
        run: |
          # Install snaps
          sudo snap install microk8s --channel=1.31-strict/stable
          sudo snap install kubectl --classic
          sudo snap install docker
          
          # Add user to microk8s group
          sudo usermod -a -G snap_microk8s $USER
          newgrp snap_microk8s

          # Wait for microk8s to start
          microk8s status --wait-ready --timeout=600 
          
          # Allow user to run microk8s commands without sudo
          microk8s config > ~/.kube/config

          # Enable required addons
          sudo microk8s addons repo add community https://github.com/canonical/microk8s-community-addons --reference feat/strict-fix-multus
          sudo microk8s enable hostpath-storage
          sudo microk8s enable multus
          sudo microk8s enable metallb:10.0.0.2-10.0.0.4
          
          # Setup local Docker registry
          docker run -d -p 5000:5000 --name registry registry:2

      - name: Run integration tests
        run: |
          make oci-build
          make deploy
          make test
